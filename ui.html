<!-- <h2>Rectangle Creator</h2>
<p>Count: <input id="count" value="5"></p>
<button id="create">Create</button>
<button id="cancel">Cancel</button>
<script>

document.getElementById('create').onclick = () => {
  const textbox = document.getElementById('count');
  const count = parseInt(textbox.value, 10);
  parent.postMessage({ pluginMessage: { type: 'create-rectangles', count } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

</script> -->

<input type="file" name="" id="input" multiple>
<p id="fileCounter">No files selected</p>

<button onclick="handleSubmit()">Insert</button>

<input type="file" name="" id="inputDir" webkitdirectory multiple>
<button onclick="handleWebkitSubmit()">Select Folder</button>

<ul id="previewList">

</ul>

<p id="status"></p>
<div>
  <img id="output">
</div>

<script>
  console.log(this)

  var files

  const inputElement = document.getElementById("input");
  inputElement.addEventListener("change", readmultifiles, false);

  const inputElementDir = document.getElementById("inputDir");
  inputElementDir.addEventListener("input", handleWebkitDir, false);

  const status = document.getElementById('status');
  const output = document.getElementById('output');
  function handleFiles() {
    //   const fileCount = this.files.length; /* now you can work with the file list */
    //   console.log(this.files);
    //   files = this.files
    //   console.log(files);
    // document.getElementById("fileCounter").innerHTML = fileCount

    output.src = '';
    status.textContent = '';
    const file = event.target.files[0];
    if (!file.type) {
      status.textContent = 'Error: The File.type property does not appear to be supported on this browser.';
      return;
    }
    if (!file.type.match('image.*')) {
      status.textContent = 'Error: The selected file does not appear to be an image.'
      return;
    }
    const reader = new FileReader();
    reader.addEventListener('load', event => {
      console.log("loaded");
      console.log(event.target);
    });

    reader.addEventListener('progress', (event) => {
      if (event.loaded && event.total) {
        const percent = (event.loaded / event.total) * 100;
        console.log(`Progress: ${Math.round(percent)}`);
      }
    });

    reader.readAsText(file);
  }

  function handleSubmit() {
    fileList.forEach(file => {
      const parser = new DOMParser();

      const doc = parser.parseFromString(file, "image/svg+xml")
      console.log(doc);
      status.textContent = file

      const title = doc.getElementsByTagName("title")[0].innerHTML
      console.log(title);


      parent.postMessage({ pluginMessage: { type: 'create-svg', doc: file, title: title } }, '*')


    })
  }

  let fileList = []

  function readmultifiles(e) {

    console.log(e);

    const files = e.currentTarget.files;

    Object.keys(files).forEach(i => {
      console.log(files[i].size);
    })

    Object.keys(files).forEach(i => {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = (e) => {
        //server call for uploading or reading the files one-by-one
        //by using 'reader.result' or 'file'
        console.log(event.target.result);
        fileList.push(event.target.result)
      }
      reader.readAsBinaryString(file);
    })
  };


  let filesArray = []

  //Select folder
  function handleWebkitDir(e) {
    // console.log(e.target.files);

    let _files = []

    Object.keys(e.target.files).forEach(i => {
      const file = e.target.files[i]
      if (!validFileType(file)) {
        console.log(`skipped: ${file.name} in ${file.webkitRelativePath} with file type: ${file.type} .`);
        return
      }
      _files.push(file)
    })

    Object.keys(_files).forEach(i => {
      const file = _files[i]

      // console.log(svgSize);
      // console.log(getIconSize(file));

      getSvgString(file).then(result => {
        let svgString = result
        // console.log(result)
        // console.log(filesArray[i]);

        const svgSize = getIconSize(svgString)

        filesArray[i].svg = svgString
        filesArray[i].dimensions = svgSize



        console.log("READY");


      })

      filesArray.push({
        name: file.name,
        svg: "",
        dimensions: ""
      })

      //TODO: split svg paths

    })

    console.log(filesArray);

    const previewList = document.getElementById("previewList")

    filesArray.forEach(element => {
      const li = document.createElement("li");
      li.appendChild(document.createTextNode(element.name));
      previewList.appendChild(li);
    });



  }

  //return folder array 
  function splitPath(file) {

  }

  async function getSvgString(file) {
    const svgPromise = await file.text();
    return svgPromise
  }

  //get icon size from svg string 
  function getIconSize(_string) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(_string, "image/svg+xml")

    dimensions = doc.firstChild.viewBox.baseVal
    return [dimensions.width, dimensions.height]
  }

  const fileTypes = [
    "image/svg+xml",
  ];

  function validFileType(file) {
    return fileTypes.includes(file.type);
  }

  //Submit button for webkit dir
  function handleWebkitSubmit() {
    parent.postMessage({ pluginMessage: { type: 'create-library', doc: filesArray } }, '*')
  }

</script>