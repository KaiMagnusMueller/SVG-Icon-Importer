<input type="file" name="" id="inputDir" webkitdirectory multiple>
<button onclick="handleWebkitSubmit()">Insert Selection</button>

<ul id="previewList">

</ul>

<p id="status"></p>
<div>
  <img id="output">
</div>

<style>
  ul {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-gap: 10px;
    /* margin: 0; */
    padding: 0;
  }

  li {
    list-style: none;
    border-radius: 4px;
    border: 2px solid #e0e0e0;
  }

  li:hover {
    background-color: rgb(228, 228, 228);
  }

  li div {
    aspect-ratio: 1/1;
    padding: 2px;
  }

  div svg {
    aspect-ratio: 1;
  }

  li p {
    display: none;
  }
</style>

<script>
  let _figmaNodes

  onmessage = (event) => {
    console.log("got this from the plugin code", event.data.pluginMessage)

    if (event.data.pluginMessage.type == "loaded-nodes") {

      _figmaNodes = event.data.pluginMessage.data

      // handeLoadedNodes(event.data.pluginMessage.data)
    } else if (event.data.pluginMessage.type == "loaded-nodes-empty") {
      handeEmptyNodes()
    }
  }

  //TODO: handle nodes


  // console.log(this)

  const inputElementDir = document.getElementById("inputDir");
  inputElementDir.addEventListener("input", handleWebkitDir, false);


  let filesArray = []

  //Select folder
  function handleWebkitDir(e) {
    // console.log(e.target.files);

    let _files = []

    Object.keys(e.target.files).forEach(i => {
      const file = e.target.files[i]
      if (!validFileType(file)) {
        console.log(`skipped: ${file.name} in ${file.webkitRelativePath} with file type: ${file.type} .`);
        return
      }
      _files.push(file)
    })

    Object.keys(_files).forEach(i => {
      const file = _files[i]

      // console.log(svgSize);
      // console.log(getIconSize(file));

      getSvgString(file).then(result => {
        let svgString = result
        // console.log(result)
        // console.log(filesArray[i]);

        const svgDoc = parseDOM(svgString)
        const svgSize = getIconSize(svgDoc)


        const pathData = getPathData(file)

        filesArray.push({
          name: file.name,
          svg: svgString,
          dimensions: svgSize,
          hash: cyrb53(svgString)
        })



        // console.log(svgDoc);


        const previewList = document.getElementById("previewList")
        const li = document.createElement("li");
        //append svg container
        li.appendChild(document.createElement("div"))
        //append svg element from parsed doc
        li.getElementsByTagName("div")[0].appendChild(svgDoc.firstChild);
        //create headling
        li.appendChild(document.createElement("p"));
        //add heading text
        li.getElementsByTagName("p")[0].innerHTML = file.name
        //append list item
        previewList.appendChild(li);


        if (i == _files.length - 1) {
          console.log(filesArray[0]);
          console.log(_figmaNodes[0]);
          handeLoadedNodes(_figmaNodes, filesArray)
        }


      })







      //TODO: split svg paths


    })



  }

  //return folder array 
  function getPathData(file) {



  }

  async function getSvgString(file) {
    const svgPromise = await file.text();
    return svgPromise
  }

  //parse document from string
  function parseDOM(_string) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(_string, "image/svg+xml")
    return doc
  }

  //get icon size from svg doc 
  function getIconSize(_doc) {

    dimensions = _doc.firstChild.viewBox.baseVal
    return [dimensions.width, dimensions.height]
  }

  const fileTypes = [
    "image/svg+xml",
  ];

  function validFileType(file) {
    return fileTypes.includes(file.type);
  }

  //Submit button for webkit dir
  function handleWebkitSubmit() {

    console.log(filesArray);

    parent.postMessage({ pluginMessage: { type: 'create-library', doc: filesArray } }, '*')
  }

  function handeLoadedNodes(_figmaNodes, uiFiles) {



    const figmaHash = _figmaNodes.map(a => a.hash)
    const filesHash = uiFiles.map(a => a.hash)

    console.log("difference");

    // console.log(filesArray.map(b => b.hash));
    // console.log(figmaHash);
    // console.log(filesHash);


    // console.log("difference");
    // console.log(_figmaNodes);
    // console.log(uiFiles);

    // console.log(_figmaNodes[0]);
    // console.log(uiFiles[0].svg);



    const _difference = figmaHash.diff(filesHash)

    console.log(_difference);
    console.log("end difference");

  }



  const cyrb53 = function (str, seed = 0) {
    let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
    for (let i = 0, ch; i < str.length; i++) {
      ch = str.charCodeAt(i);
      h1 = Math.imul(h1 ^ ch, 2654435761);
      h2 = Math.imul(h2 ^ ch, 1597334677);
    }
    h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
    h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
    return 4294967296 * (2097151 & h2) + (h1 >>> 0);
  };

  Array.prototype.diff = function (arr2) { return this.filter(x => !arr2.includes(x)); }


</script>