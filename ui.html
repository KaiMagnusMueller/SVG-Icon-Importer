<input type="file" name="" id="inputDir" webkitdirectory multiple>
<button onclick="handleWebkitSubmit()">Insert Selection</button>

<ul id="previewList">

</ul>

<p id="status"></p>
<div>
  <img id="output">
</div>

<script>
  // console.log(this)

  const inputElementDir = document.getElementById("inputDir");
  inputElementDir.addEventListener("input", handleWebkitDir, false);


  let filesArray = []

  //Select folder
  function handleWebkitDir(e) {
    // console.log(e.target.files);

    let _files = []

    Object.keys(e.target.files).forEach(i => {
      const file = e.target.files[i]
      if (!validFileType(file)) {
        console.log(`skipped: ${file.name} in ${file.webkitRelativePath} with file type: ${file.type} .`);
        return
      }
      _files.push(file)
    })

    Object.keys(_files).forEach(i => {
      const file = _files[i]

      // console.log(svgSize);
      // console.log(getIconSize(file));

      getSvgString(file).then(result => {
        let svgString = result
        // console.log(result)
        // console.log(filesArray[i]);

        const svgSize = getIconSize(svgString)

        filesArray[i].svg = svgString
        filesArray[i].dimensions = svgSize



        console.log("READY");


      })

      filesArray.push({
        name: file.name,
        svg: "",
        dimensions: ""
      })

      //TODO: split svg paths

    })

    console.log(filesArray);

    const previewList = document.getElementById("previewList")

    filesArray.forEach(element => {
      const li = document.createElement("li");
      li.appendChild(document.createTextNode(element.name));
      previewList.appendChild(li);
    });



  }

  //return folder array 
  function splitPath(file) {

  }

  async function getSvgString(file) {
    const svgPromise = await file.text();
    return svgPromise
  }

  //get icon size from svg string 
  function getIconSize(_string) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(_string, "image/svg+xml")

    dimensions = doc.firstChild.viewBox.baseVal
    return [dimensions.width, dimensions.height]
  }

  const fileTypes = [
    "image/svg+xml",
  ];

  function validFileType(file) {
    return fileTypes.includes(file.type);
  }

  //Submit button for webkit dir
  function handleWebkitSubmit() {
    parent.postMessage({ pluginMessage: { type: 'create-library', doc: filesArray } }, '*')
  }

</script>