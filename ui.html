<!-- <h2>Rectangle Creator</h2>
<p>Count: <input id="count" value="5"></p>
<button id="create">Create</button>
<button id="cancel">Cancel</button>
<script>

document.getElementById('create').onclick = () => {
  const textbox = document.getElementById('count');
  const count = parseInt(textbox.value, 10);
  parent.postMessage({ pluginMessage: { type: 'create-rectangles', count } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

</script> -->

<input type="file" name="" id="input" multiple>
<p id="fileCounter">No files selected</p>

<button onclick="handleSubmit()">Insert</button>

<input type="file" name="" id="inputDir" webkitdirectory multiple">
<button onclick="handleWebkitSubmit()">Select Folder</button>

<p id="status"></p>
<div>
  <img id="output">
</div>

<script>
  console.log(this)

  var files

  const inputElement = document.getElementById("input");
  inputElement.addEventListener("change", readmultifiles, false);

  const inputElementDir = document.getElementById("inputDir");
  inputElementDir.addEventListener("input", handleWebkitDir, false);

  const status = document.getElementById('status');
  const output = document.getElementById('output');
  function handleFiles() {
    //   const fileCount = this.files.length; /* now you can work with the file list */
    //   console.log(this.files);
    //   files = this.files
    //   console.log(files);
    // document.getElementById("fileCounter").innerHTML = fileCount

    output.src = '';
    status.textContent = '';
    const file = event.target.files[0];
    if (!file.type) {
      status.textContent = 'Error: The File.type property does not appear to be supported on this browser.';
      return;
    }
    if (!file.type.match('image.*')) {
      status.textContent = 'Error: The selected file does not appear to be an image.'
      return;
    }
    const reader = new FileReader();
    reader.addEventListener('load', event => {
      console.log("loaded");
      console.log(event.target);
    });

    reader.addEventListener('progress', (event) => {
      if (event.loaded && event.total) {
        const percent = (event.loaded / event.total) * 100;
        console.log(`Progress: ${Math.round(percent)}`);
      }
    });

    reader.readAsText(file);
  }

  function handleSubmit() {
    fileList.forEach(file => {
      const parser = new DOMParser();

      const doc = parser.parseFromString(file, "image/svg+xml")
      console.log(doc);
      status.textContent = file

      const title = doc.getElementsByTagName("title")[0].innerHTML
      console.log(title);


      parent.postMessage({ pluginMessage: { type: 'create-svg', doc: file, title: title } }, '*')


    })
  }

  let fileList = []

  function readmultifiles(e) {

    console.log(e);

    const files = e.currentTarget.files;

    Object.keys(files).forEach(i => {
      console.log(files[i].size);
    })

    Object.keys(files).forEach(i => {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = (e) => {
        //server call for uploading or reading the files one-by-one
        //by using 'reader.result' or 'file'
        console.log(event.target.result);
        fileList.push(event.target.result)
      }
      reader.readAsBinaryString(file);
    })
  };



  //Select folder
  function handleWebkitDir(e) {
    // console.log(e.target.files);

    let filesArray = []


    Object.keys(e.target.files).forEach(i => {
      const file = e.target.files[i]
      if (!validFileType(file)) {
        console.log(`skipped: ${file.name} in ${file.webkitRelativePath} with file type: ${file.type} .`);
        return
      }


      const svgSize = getIconSize(file)


      // console.log(svgSize);
      // console.log(getIconSize(file));

      const svgString = getSvgString(file).then((result) => {
        return result
      })


      // console.log(`svg size: `);
      // console.log(svg);


      filesArray.push({
        name: file.name,
        svg: svgString,
        dimensions: svgSize
      })

      //TODO: split svg paths

    })

    console.log(filesArray);

    // const svgString = getSvgString(filesArray[0])

    // console.log(svgString.result);



    // Object.keys(e.target.files).forEach(i => {

    //   file = e.target.files[i]


    //   let svgString
    //   const svgStringPromise = getSvgString(file)

    //   svgString = svgStringPromise.then((result) => {
    //     return result
    //   })

    //   console.log(svgString);

    //   // const svgSize = getIconSize(svgString)

    //   fileArray.push({
    //     name: file.name,
    //     // file: svgSize
    //   })
    // })

    // console.log(fileArray);


    // fileArray.forEach(file => {
    //   console.log(file.path)
    // })

    // for (let i = 0; i < fileArray.length; i++) {
    //   const element = fileArray[i];
    //   console.log(element.webkitRelativePath);
    // }
  }

  //return folder array 
  function splitPath(file) {

  }

  async function getSvgString(file) {

    const svgPromise = await file.text();
    const svg = await svgPromise
    return svg

    // try {
    //   const data = await file.text()
    //   console.log(data);
    //   return data

    // } catch (error) {
    //   console.log(`Could not read file ${file.name}`);
    // }
  }

  //get icon size from svg string 
  function getIconSize(_file) {

    return getSvgString(_file).then((result) => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(result, "image/svg+xml")

      dimensions = doc.firstChild.viewBox.baseVal

      return [dimensions.width, dimensions.height]
    })
  }

  const fileTypes = [
    "image/svg+xml",
  ];

  function validFileType(file) {
    return fileTypes.includes(file.type);
  }

  //Submit button for webkit dir
  async function handleWebkitSubmit() {
    const dirHandle = await document.window.showOpenFilePicker();

    const file = await dirHandle.getFile();


    console.log(dirHandle);
    console.log(file);
  }

</script>